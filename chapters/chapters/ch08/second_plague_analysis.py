import pandas as pd
import numpy as np

def analyze_second_plague(data: pd.DataFrame):
    """ë‘ ë²ˆì§¸ ì¬ì•™ (ê°œêµ¬ë¦¬) ë¶„ì„: ê³ ì„¼ ë•…ì˜ êµ¬ë³„ê³¼ ë§ˆìŠ¤í‚¹"""
    print("\nğŸ¸ ë‘ ë²ˆì§¸ ì¬ì•™, ê°œêµ¬ë¦¬: ê³ ì„¼ ë•…ì˜ êµ¬ë³„ê³¼ ë°ì´í„° ë§ˆìŠ¤í‚¹")
    print("=" * 60)

    if data is None:
        print("âš ï¸ ë¶„ì„í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.")
        return None

    print("ğŸ“Š ì›ë³¸ ê°œêµ¬ë¦¬ ì¬ì•™ ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°:")
    print(data.head())
    print("\n")

    # 1. ê³ ì„¼ ë•…ê³¼ ë‹¤ë¥¸ ì§€ì—­ì˜ ê°œêµ¬ë¦¬ ìˆ˜ì¤€ ë¹„êµ (êµ¬ë³„)
    print("ğŸ” ê³ ì„¼ ë•…ê³¼ ì• êµ½ ì „ì—­ì˜ ê°œêµ¬ë¦¬ ìˆ˜ì¤€ ë¹„êµ (ë°ì´í„° êµ¬ë³„):")
    goshen_data = data[data['ê³ ì„¼_ê°œêµ¬ë¦¬_ìˆ˜ì¤€'] > 0][['ë‚ ì§œ', 'ê³ ì„¼_ê°œêµ¬ë¦¬_ìˆ˜ì¤€']]
    egypt_data = data[data['ì• êµ½_ì „ì—­_ê°œêµ¬ë¦¬_ìˆ˜ì¤€'] > 50][['ë‚ ì§œ', 'ì• êµ½_ì „ì—­_ê°œêµ¬ë¦¬_ìˆ˜ì¤€']]

    if not goshen_data.empty:
        print("   ê³ ì„¼ ë•… (ê°œêµ¬ë¦¬ ì¶œí˜„ ê¸°ë¡):\n", goshen_data)
    else:
        print("   ê³ ì„¼ ë•…ì—ëŠ” ê°œêµ¬ë¦¬ ì¶œí˜„ ê¸°ë¡ì´ ê±°ì˜ ì—†ìŠµë‹ˆë‹¤. (í•˜ë‚˜ë‹˜ì˜ êµ¬ë³„)")

    if not egypt_data.empty:
        print("\n   ì• êµ½ ì „ì—­ (ì‹¬ê°í•œ ê°œêµ¬ë¦¬ ì¶œí˜„ ê¸°ë¡):\n", egypt_data)

    # 2. ë°ì´í„° ë§ˆìŠ¤í‚¹ (df.mask)ì„ ì‚¬ìš©í•˜ì—¬ ê³ ì„¼ ë•… ë°ì´í„° 'ë³´í˜¸'
    # ì• êµ½ ì „ì—­ì˜ ê°œêµ¬ë¦¬ ìˆ˜ì¤€ì„ ë³´ì—¬ì£¼ë˜, ê³ ì„¼ ë•… ìˆ˜ì¤€ì´ 0ì´ ì•„ë‹Œ ê²½ìš°ë§Œ í‘œì‹œ (ë°ì´í„° ë³´í˜¸)
    print("\nğŸ›¡ï¸ ë°ì´í„° ë§ˆìŠ¤í‚¹ (ê³ ì„¼ ë•… ë³´í˜¸): ì• êµ½ ì „ì—­ ë°ì´í„°ì—ì„œ ê³ ì„¼ ë•… ì˜í–¥ ì œì™¸")
    # ê³ ì„¼ ë•… ê°œêµ¬ë¦¬ ìˆ˜ì¤€ì´ 0ë³´ë‹¤ í° ê²½ìš° (ì¦‰, ê³ ì„¼ ë•…ì— ê°œêµ¬ë¦¬ê°€ ìˆëŠ” ê²½ìš°), ì• êµ½ ì „ì—­ ê°’ì„ NaNìœ¼ë¡œ ë§ˆìŠ¤í¬
    masked_egypt_plague = data['ì• êµ½_ì „ì—­_ê°œêµ¬ë¦¬_ìˆ˜ì¤€'].mask(data['ê³ ì„¼_ê°œêµ¬ë¦¬_ìˆ˜ì¤€'] > 0, np.nan)
    # ì›ë³¸ ë°ì´í„°í”„ë ˆì„ì— ì¶”ê°€í•˜ì—¬ ë¹„êµ
    data['ë§ˆìŠ¤í‚¹ëœ_ì• êµ½_ê°œêµ¬ë¦¬_ìˆ˜ì¤€'] = masked_egypt_plague
    print(data[['ë‚ ì§œ', 'ì• êµ½_ì „ì—­_ê°œêµ¬ë¦¬_ìˆ˜ì¤€', 'ê³ ì„¼_ê°œêµ¬ë¦¬_ìˆ˜ì¤€', 'ë§ˆìŠ¤í‚¹ëœ_ì• êµ½_ê°œêµ¬ë¦¬_ìˆ˜ì¤€']].head(7))
    print("\n   í†µì°°: `mask()`ëŠ” íŠ¹ì • ì¡°ê±´ì— ë”°ë¼ ê°’ì„ 'ìˆ¨ê¸°ê±°ë‚˜' ë‹¤ë¥¸ ê°’ìœ¼ë¡œ ëŒ€ì²´í•  ë•Œ ìœ ìš©í•©ë‹ˆë‹¤. ì—¬ê¸°ì„œëŠ” ê³ ì„¼ ë•…ì´ ë³´í˜¸ë°›ëŠ” ê²ƒì„ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.")

    # 3. ë°ì´í„° í•„í„°ë§ (df.where)ì„ ì‚¬ìš©í•˜ì—¬ íŒŒë¼ì˜¤ ë°˜ì‘ ì¡°ê±´ë¶€ ë¶„ì„
    print("\nâš–ï¸ ì¡°ê±´ë¶€ ë°ì´í„° ì„ íƒ (íŒŒë¼ì˜¤ì˜ ê°•í…í•¨ ë¶„ì„): íŒŒë¼ì˜¤ê°€ íƒ€í˜‘ì„ ì‹œë„í•œ ë‚ ë§Œ ë¶„ì„")
    # íŒŒë¼ì˜¤ê°€ ë°˜ì‘(1)ì„ ë³´ì¸ ë‚ ì§œì˜ ë°ì´í„°ë§Œ ì„ íƒ
    pharaoh_response_days = data.where(data['íŒŒë¼ì˜¤_ë°˜ì‘'] == 1).dropna(subset=['íŒŒë¼ì˜¤_ë°˜ì‘'])
    if not pharaoh_response_days.empty:
        print(pharaoh_response_days[['ë‚ ì§œ', 'íŒŒë¼ì˜¤_ë°˜ì‘', 'ì• êµ½_ì „ì—­_ê°œêµ¬ë¦¬_ìˆ˜ì¤€']])
        print("\n   í†µì°°: `where()`ëŠ” íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” í–‰ë§Œ ì„ íƒí•˜ê³ , ë‚˜ë¨¸ì§€ëŠ” NaNìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ë°ì´í„°ë¥¼ í•„í„°ë§í•˜ëŠ” ë° ìœ ìš©í•©ë‹ˆë‹¤.")
    else:
        print("   íŒŒë¼ì˜¤ê°€ íƒ€í˜‘ì„ ì‹œë„í•œ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤.")

    # 4. ì¬ì•™ ê°•ë„ì— ë”°ë¥¸ íŒŒë¼ì˜¤ ë°˜ì‘ ê²½í–¥ ë¶„ì„
    print("\nğŸ“ˆ ì¬ì•™ ê°•ë„ì— ë”°ë¥¸ íŒŒë¼ì˜¤ ë°˜ì‘ ê²½í–¥:")
    plague_response_trend = data.groupby('íŒŒë¼ì˜¤_ë°˜ì‘')['ì• êµ½_ì „ì—­_ê°œêµ¬ë¦¬_ìˆ˜ì¤€'].mean().reset_index()
    print(plague_response_trend)
    print("\n   í†µì°°: íŒŒë¼ì˜¤ê°€ íƒ€í˜‘ì ì¼ ë•Œ (ë°˜ì‘=1) ê°œêµ¬ë¦¬ ìˆ˜ì¤€ì´ ë” ë†’ê±°ë‚˜ ë‚®ì€ì§€ í‰ê· ì„ í†µí•´ ê²½í–¥ì„ íŒŒì•…í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

    # ì¶”ê°€: íŠ¹ì • ì¡°ê±´ ë§Œì¡±í•˜ëŠ” ë°ì´í„° ì¿¼ë¦¬ (df.query)
    print("\nğŸ” ë°ì´í„° ì¿¼ë¦¬ (íŠ¹ì • ì¬ì•™ ì¡°ê±´ ì¶©ì¡±): ì• êµ½ ì „ì—­ ê°œêµ¬ë¦¬ ìˆ˜ì¤€ì´ 70 ì´ìƒì¸ ë‚ ì§œ")
    high_plague_days = data.query('`ì• êµ½_ì „ì—­_ê°œêµ¬ë¦¬_ìˆ˜ì¤€` >= 70')
    if not high_plague_days.empty:
        print(high_plague_days[['ë‚ ì§œ', 'ì• êµ½_ì „ì—­_ê°œêµ¬ë¦¬_ìˆ˜ì¤€', 'íŒŒë¼ì˜¤_ë°˜ì‘']])
        print("\n   í†µì°°: `query()`ëŠ” SQLê³¼ ìœ ì‚¬í•œ ë¬¸ìì—´ ê¸°ë°˜ì˜ ì¡°ê±´ìœ¼ë¡œ DataFrameì„ í•„í„°ë§í•  ë•Œ ë§¤ìš° í¸ë¦¬í•©ë‹ˆë‹¤.")
    else:
        print("   ì• êµ½ ì „ì—­ì˜ ê°œêµ¬ë¦¬ ìˆ˜ì¤€ì´ 70 ì´ìƒì¸ ë‚ ì§œê°€ ì—†ìŠµë‹ˆë‹¤.")


    return {
        "goshen_distinction_analysis": goshen_data,
        "masked_egypt_plague": masked_egypt_plague,
        "pharaoh_response_days": pharaoh_response_days,
        "plague_response_trend": plague_response_trend,
        "high_plague_days": high_plague_days
    }

if __name__ == "__main__":
    print("ğŸ“š Second Plague Analysis ëª¨ë“ˆ í…ŒìŠ¤íŠ¸")
    from chapters.ch08.second_plague_data import generate_second_plague_data
    test_data = generate_second_plague_data(days=15)
    if test_data is not None:
        results = analyze_second_plague(test_data)
        print("\nâœ… ë¶„ì„ ì™„ë£Œ!")
    else:
        print("âŒ ë°ì´í„° ìƒì„± ì‹¤íŒ¨. ë¶„ì„ì„ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
